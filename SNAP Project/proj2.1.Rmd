---
title: "proj2.1"
author: "Yangyang Dai"
date: "2/1/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(fmsb)
library(plotly)
library(MASS)
library(mosaic)
library(knitr)
library(tidyverse)
library(ggformula)
library(gridExtra)
library(broom)
library(binom)
library(scales)
require(xlsx)
library(ggplot2)
library(gtable)
library(grid)
require("devtools")
library("tidyverse")
library("viridis")
library("urbnmapr")
library(data.table)
library(scales)
library(lubridate)
library(ggplot2)
devtools::install_github("UrbanInstitute/urbnmapr")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# skip first 6 rows, and only read in 1st and 4th col
part_18 <-read.xlsx("snap_part_2018.xls",header=F,skip=6,sheetIndex = 1)
part_18<-part_18[-c(9,48,49),][7:58,]
colnames(part_18) <- c("state","sep17","aug18","sep18","sep18_vs_aug18","sep18_vs_sep17")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
r1="Northeast"
r2="Midwest"
r3="South"
r4="West"

s1<-c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont", "New Jersey", "New York","Pennsylvania")
s2<-c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota")
s3<-c("Delaware", "Florida", "Georgia", "Maryland", "North Carolina", "South Carolina", "Virginia", "District of Columbia", "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas", "Louisiana", "Oklahoma", "Texas")
s4<-c("Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah", "Wyoming","Alaska", "California", "Hawaii", "Oregon", "Washington")


for (row in 1:nrow(part_18)) {
  state <- part_18[row, "state"]
  if (state %in% s1) {
  region = r1
}else if(state %in% s2){
  region = r2
}else if(state %in% s3){
  region = r3
}else if(state %in% s4) {
  region = r4
}
  part_18$region[row] <- region}

```

```{r include=FALSE}
part_18
data<-part_18[c("state","sep18","region")]
data
```

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '90%',fig.width=6, fig.height=6,}
data = data %>% arrange(region, as.numeric(as.character(sep18)))

# Set a number of 'empty bar' to add at the end of each group
empty_bar=3
to_add = data.frame( matrix(NA, empty_bar*nlevels(data$region), ncol(data)) )
colnames(to_add) = colnames(data)
to_add$group=rep(levels(data$region), each=empty_bar)
data=rbind(data, to_add)
data=data %>% arrange(region)
data$id=seq(1, nrow(data))


# Get the name and the y position of each label
label_data=data
number_of_bar=nrow(label_data)
angle= 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust<-ifelse( angle < -90, 1, 0)
label_data$angle<-ifelse(angle < -90, angle+180, angle)
 
# prepare a data frame for base lines
base_data=data %>% 
  group_by(region) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))


# prepare a data frame for grid (scales)
grid_data = base_data
grid_data$end = grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start = grid_data$start - 1
grid_data=grid_data[-1,]


# Make the plot
p = ggplot(data, aes(x=as.factor(id), y=as.numeric(as.character(sep18)), fill=region)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar

  geom_bar(aes(x=as.factor(id), y=as.numeric(as.character(sep18)), fill=region), stat="identity", alpha=0.5) +

  # Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 4000000, xend = start, yend = 4000000), colour = "grey", alpha=1, size=0.1 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 3000000, xend = start, yend = 3000000), colour = "grey", alpha=1, size=0.1 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 2000000, xend = start, yend = 2000000), colour = "grey", alpha=1, size=0.1 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 1000000, xend = start, yend = 1000000), colour = "grey", alpha=1, size=0.1 , inherit.aes = FALSE ) +

  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(1, 2, 3, 4), label = c("1", "2", "3", "4") , color="grey", size=3 , angle=0, fontface="bold", hjust=1) +

  geom_bar(aes(x=as.factor(id), y=as.numeric(as.character(sep18)), fill=region), stat="identity", alpha=0.5) +
  ylim(-1500000,4000000) +
theme_minimal()+
theme(plot.caption = element_text(hjust = 0),
  legend.position = "none",
  axis.text = element_blank(),
  axis.title = element_blank(),
  panel.grid = element_blank(),
  # plot.title = element_text(),
  plot.title=element_text(size=17, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=10, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5)
)+
  coord_polar()+
  geom_text(data=label_data, aes(x=id, y=as.numeric(as.character(sep18))+800000, label=state, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data$angle, inherit.aes = FALSE ) +

  # Add base line information
  geom_segment(data=base_data, aes(x = start, y =-100000, xend = end, yend = -100000), colour = "black", alpha=0.8, size=0.6, inherit.aes = FALSE )  +
  geom_text(data=base_data, aes(x = title, y = -180000, label=region), hjust=c(0.9,1,0.35,0), colour = "black", alpha=0.8, size=2, fontface="bold", inherit.aes = FALSE)+
  labs(title="US SNAP Participation by State in 2018", subtitle="SNAP participation population has huge range across states in different regions", caption = "Source: USDA Food Nutrition Services\nhttps://www.fns.usda.gov/pd/supplemental-nutrition-assistance-program-snap")

p

```


```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '80%',include=FALSE}
part_18 <- part_18[!grepl("Guam", part_18$state),]

ggplot(data=part_18,aes(x=reorder(state,as.numeric(as.character(sep18))),as.numeric(as.character(sep18))),fill="steel blue") + scale_y_continuous(label=c("0","1m","2m","3m","4m"))+geom_col() + coord_flip() +  facet_grid(region~.,scales="free_y") +
  labs(x = "state", y = "Participation population 2018",
       title="US SNAP Participation by State in 2018", subtitle="SNAP participation population has huge range across states in different regions", caption = "Source: USDA Food Nutrition Services \n  https://www.fns.usda.gov/pd/supplemental-nutrition-assistance-program-snap") +
  theme( axis.text=element_text(color="black"), strip.text.y=element_text(size=9), strip.background=element_rect(fill="white"), panel.grid.major.y=element_blank(), panel.grid.minor.x=element_blank(), axis.ticks=element_blank()) 
```

Participation population of SNAP program in US across the 51 states, four regions, are shown above. West has the widest range of participation numbers, while the it's more concentrated for Midwest. Overall, at state level, California has the most participations, nearly 4 million, and Wyoming has the fewest participants, about 0.1 million.


```{r echo=FALSE, message=FALSE, warning=FALSE}
part_ben<-read.xlsx("part_ben_89to18.xlsx",header=TRUE,sheetIndex = 1)
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
snap<-read.xlsx("DataDownload.xls",head=T,sheetIndex = 10)
df<-snap
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# states %>%
#   ggplot() +
#   geom_polygon(aes(long, lat, group = group), 
#                fill = "grey", color = "#ffffff", size = 0.25) +
#   coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
#   geom_text(data = get_urbn_labels(map = "states"), aes(x = long, lat, label = state_abbv), 
#             size = 3)
        
```


```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '80%'}
pop <- read.delim("data.txt",header = TRUE, sep = ",")
# part_18:
# Guam
# Virgin Islands

# pop:
# Rhode Island

# pop$part.18
# pop$X2019.Population
# pop$part.per.capita

colnames(pop)[colnames(pop)=="State"] <- "state_name"
# part_18<-part_18[ ! part_18$state %in% c("Guam","Virgin Islands"), ]
# pop<-pop[ ! pop$state %in% c("Rhode Island"), ]
# pop$part.18<-part_18$sep18
# pop$part.per.capita<-as.numeric(pop$part.18)/as.numeric(pop$X2019.Population)

pop %>%
  left_join(states, by = "state_name") %>% 
  ggplot(mapping = aes(long, lat, group = group, fill = X..of.US)) +labs(title="US SNAP Participation per capita by State", subtitle="State SNAP participation rate has small range", caption="Source:USDA Food Nutrition Services")+theme(plot.caption = element_text(hjust = 0),legend.text = element_text(size = 8),legend.title=element_text(size=6,face="bold"),plot.title=element_text(size=20, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=15, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5),  # subtitlepanel.grid.major = element_line(colour = 'transparent'),
 axis.title.x=element_blank(), 
 axis.text.x=element_blank(),
 axis.ticks.x=element_blank(),
 axis.title.y=element_blank(), 
 axis.text.y=element_blank(),
 axis.ticks.y=element_blank(),
 panel.background=element_blank(),
 panel.border=element_blank(),
 panel.grid.minor=element_blank(),
 plot.background=element_blank(),
 legend.position = c(.95, .5)
 )+
  geom_polygon(color = "#ffffff", size = 0.25) +
  coord_map("albers", lat0 = 39, lat1 = 45)  + labs(fill = "Participation per capita") 
```
\newline
The first map is the US base map with state names labeled. From the US state map, combining with SNAP participation data, we can see that state AL, ND, SD and NH have the highest participation rate. This is reasonable as these states are less developed and tend to have more poor people. The participation rate range is not very big, therefore the colors are generally darker. Most of the states have participation rate around 0.00002 or lower.  

\newline
\newline
```{r include=FALSE}
dt <- data.table(df)
setkey(dt, State)
dt<-dt[J(unique(State)), mult = "first"]
colnames(dt)[colnames(dt)=="State"] <- "state_abbv"
state.abb[match(states$state_name,state.name)]
```
```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '80%'}
dt %>%
  left_join(states, by = "state_abbv") %>% 
  ggplot(mapping = aes(long, lat, group = group, fill = FOOD_TAX14))  +labs(title="US Food Tax", subtitle="", caption="Source:USDA Food Nutrition Services
")+theme(plot.caption = element_text(hjust = 0),panel.grid.major = element_line(colour = 'transparent'),
         plot.title=element_text(size=20, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=15, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5),
 axis.title.x=element_blank(), 
 axis.text.x=element_blank(),
 axis.ticks.x=element_blank(),
 axis.title.y=element_blank(), 
 axis.text.y=element_blank(),
 axis.ticks.y=element_blank(),
 panel.background=element_blank(),
 panel.border=element_blank(),
 panel.grid.minor=element_blank(),
 plot.background=element_blank(),
 legend.position = c(.9, .5),
 legend.text = element_text(size = 8),
 legend.title=element_text(size=6,face="bold")
 )+
  geom_polygon(color = "#ffffff", size = 0.25) +
  coord_map("albers", lat0 = 39, lat1 = 45)  + labs(fill = "Food Tax") 
```
\newline
\newline
Drawing a US Food Tax map across states and comparing it with the previous participation rate map, we can see that places with higher SNAP participation rates do not have high food tax. And places with high food tax rates tend to have low SNAP participation rates. 

\newline
\newline
\newline
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '100%'}

snap_event<-read.xlsx("snap_event.xlsx",head=T,sheetIndex = 1)

snap_event$y<-c(runif(8,.3,.5),runif(7,-.5,-.3))

positions <- c(0.5, -0.5, 1.0, -1.0, 1.5, -1.5)
directions <- c(1, -1)

line_pos <- data.frame(
    "year"=unique(snap_event$year),
    "position"=rep(positions, length.out=length(unique(snap_event$year))),
    "direction"=rep(directions, length.out=length(unique(snap_event$year)))
)

snap_event <- merge(x=snap_event, y=line_pos, by="year", all = TRUE)
snap_event <- snap_event[with(snap_event, order(year, event)), ]

text_offset <- 0.05
snap_event$text_position <- (text_offset * snap_event$direction) + snap_event$position

ggplot(snap_event,aes(x=year,y=0,  label=event))+labs(col="events")+theme_classic()+geom_hline(yintercept=0, 
                color = "black", size=1.5)+geom_segment(data=snap_event, aes(y=position,yend=0,xend=year), color='black', size=0.7)+scale_y_discrete(limits=c(-0.5,.5))+theme(plot.caption = element_text(hjust = 0),axis.line.y=element_blank(),
                 axis.text.y=element_blank(),
                 axis.title.x=element_blank(),
                 axis.title.y=element_blank(),
                 axis.ticks.y=element_blank(),
                 axis.text.x =element_blank(),
                 axis.ticks.x =element_blank(),
                 axis.line.x =element_blank(),
                 legend.position = "bottom",plot.title=element_text(size=20, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=15, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5)
                ) + geom_text(data=snap_event, aes(x=year,y=-0.2,label=year,vjust=-5, fontface="bold"),size=1.5, color='turquoise4')+geom_point(aes(y=0), size=2,color='turquoise4')+geom_text(aes(y=text_position,label=event),size=2,fontface="bold")+labs(title="SNAP 1964 - Today", subtitle="Big Events in SNAP History", caption="Source:USDA Food Nutrition Services \n https://www.fns.usda.gov/snap/short-history-snap")

```

\newline
\newline
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '80%',include=FALSE}
part_ben$Year <- as.Date(as.character(part_ben$Year), format = "%Y")
snap_event$year <- as.Date(as.character(snap_event$year), format = "%Y")

yrng <- range(part_ben$Participation.number.)
ymin <- yrng[1]
ymax <- yrng[1] + 0.1*(yrng[2]-yrng[1])

p2 <- ggplot()
p2 <- p2 + geom_line(mapping=aes(x=Year, y=Participation.number.), data=part_ben , size=2, alpha=0.5,color='blue') 
p2 <- p2 + scale_x_date("time")  +
  # scale_x_discrete(limits=c("1990","1995","2000","2005","2010","2015"))+
scale_y_continuous(name="participation")+ labs(title="SNAP Participation Population 1989-2018", subtitle="SNAP participation doubled over the last two decades", caption="Source:USDA Food Nutrition Services \n https://www.fns.usda.gov/snap/short-history-snap")+theme(plot.caption = element_text(hjust = 0),plot.title=element_text(size=20, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=15, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5))
p2
```

\newline
\newline
From 1989 to 2018, the SNAP participation number in US increased from below two millions to about four millions, almost doubled in two decades. The peaks within the two decades happened at year 1994 and year 2013, reached over 2.5 millions and over 4.5 millions respectively. Connecting to the previous SNAP timeline graph, SNAP reached participation milestone for those two years.  The Food Stamp Nutrition Education program at 1992 and Mickey Leland Childhood Hunger Relief Act at 1993 influenced the growth of SNAP, the participants increased dramatically afterwards. And from 2002 to 2014, there are five events happened that drove the SNAP participaion greatly. 

\newline
\newline
\newline
\newline

```{r include=FALSE}
time.series<-read.xlsx(("TimeSeries.xlsx"),header=T,sheetIndex = 1)[,1:4][2:50,]
colnames(time.series) <- c("Year","PopChange","UmRateChange","PovertyRateChange")
time.series
# as.numeric(as.character(time.series$PovertyRateChange))
```
\newline
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center",out.width = '80%'}
x <- list(
  title = "Year"
)
y <- list(
  title = "% Change"
)
p<-plot_ly(y=as.numeric(as.character(time.series$PopChange)), x=as.numeric(as.character(time.series$Year)) , type="scatter", mode="markers+lines",xlab="Year",ylab="Percentage Change",name="Population")%>%
  layout(xaxis = x, yaxis = y)
p<-add_trace(p, y=~as.numeric(as.character(time.series$UmRateChange)), x=~as.numeric(as.character(time.series$Year)) , type="scatter", mode="markers+lines",name="Unemployment Rate" )
p<-add_trace(p, y=~as.numeric(as.character(time.series$PovertyRateChange)), x=~as.numeric(as.character(time.series$Year)), type="scatter", mode="markers+lines",name="Poverty Rate" )
p
```

```{r echo=FALSE}
# p2 <- data %>%
#   tail(60) %>%
#   ggplot( aes(x=date, y=value)) +
#     geom_line(color="#69b3a2") +
#     geom_point(color="#69b3a2", size=2) +
#     ggtitle("Connected scatterplot") +
#     ylab("bitcoin price ($)") +
#     theme_ipsum()
```

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align = "center",out.width = '80%'}
um<-read.xlsx("um_79to18.xlsx",header=TRUE,sheetIndex = 1)[11:40,]
# um
# head(part_ben)
part_ben$um<-um$Unemployment.Rate

b <- ggplot(part_ben, aes(x = Year, y=Benefit.dollar.person.))

b + geom_point(aes(color = um), size = 3) +
  # scale_x_continuous(label=c(1990,1995,2000,2005,2010,2015))+
  scale_color_gradientn(colors = c("#00AFBB", "#E7B800", "#FC4E07"))+labs(y = "Benefits per person ($)",x = "Year",colour = "Unemployment Rate",title="SNAP benefit dollar per person and Unemployment Rate 1989-2018", subtitle="Overall the SNAP participation and benefits increased over the last two decades",caption="Source:Bureau of Labor Statistics \n https://data.bls.gov/timeseries/LNS14000000")+theme(plot.caption = element_text(hjust = 0),plot.title=element_text(size=20, 
                                    face="bold", 
                                    family="American Typewriter",
                                    color="black",
                                    hjust=0.5,
                                    lineheight=1.2),  # title
            plot.subtitle=element_text(size=15, 
                                       family="American Typewriter",
                                       face="bold",
                                       hjust=0.5))
```
\newline
\newline

From 1989 to 2018, the benefits per person increased dramatically. From around 50 dollars to above 250 dollars, the dollar benefitfive is currenly five times more than from the beginning. The color scale shows the range of unemployment rate over the years. The unemployment rate fluctuates from 1989 to 2008, and increased dramatically around 2008 to 2014, which is the financial crisis period. The benefit per person decreased a little, but after the crisis, the benefit jumped very high till around 250 dollars per person and came back to around 125 in the most recent year.  

```{r include=FALSE}
# Create data: note in High school for several students
data = as.data.frame(matrix(
  c(6.4, 6.3,6.2,22, 23,24,81,78,74),
  nrow=3
))
colnames(data)=c("WIC" ,"School Lunch" , "SNAP")
rownames(data)=c("2016","2017","2018")
data
# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each topic to show on the plot!
data=rbind(rep(200,10) , rep(0,10) , data)

#==================
# Plot 1: Default radar chart proposed by the library:
radarchart(data)

#==================
# Plot 2: Same plot with custom features
# colors_border=c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9) , rgb(0.7,0.5,0.1,0.9) )
# colors_in=c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4) , rgb(0.7,0.5,0.1,0.4) )
# radarchart( data  , axistype=1 ,
#     #custom polygon
#     pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
#     #custom the grid
#     cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8,
#     #custom labels
#     vlcex=0.8
#     )
# legend(x=0.7, y=1, legend = rownames(data[-c(1,2),]), bty = "n", pch=20 , col=colors_in , text.col = "grey", cex=1.2, pt.cex=3)

#=================
# Plot3: If you remove the 2 first lines, the function compute the max and min of each variable with the available data:
# colors_border=c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9) , rgb(0.7,0.5,0.1,0.9) )
# colors_in=c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4) , rgb(0.7,0.5,0.1,0.4) )
# radarchart( data[-c(1,2),]  , axistype=0 , maxmin=F,
#     #custom polygon
#     pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
#     #custom the grid
#     cglcol="grey", cglty=1, axislabcol="black", cglwd=0.8,
#     #custom labels
#     vlcex=0.8
#     )
# legend(x=0.7, y=1, legend = rownames(data[-c(1,2),]), bty = "n", pch=20 , col=colors_in , text.col = "grey", cex=1.2, pt.cex=3)
```












